<?xml version="1.0" encoding="UTF-8"?>
<article version="5.0" xmlns="http://docbook.org/ns/docbook"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:svg="http://www.w3.org/2000/svg"
         xmlns:mml="http://www.w3.org/1998/Math/MathML"
         xmlns:html="http://www.w3.org/1999/xhtml"
         xmlns:db="http://docbook.org/ns/docbook">
  <title>README</title>

  <info>
    <author>
      <personname>Charles Loomis</personname>
    </author>

    <abstract>
      <para>This document describes important changes in the pan compiler
      between the current release major release (v8) and previous ones as well
      as identified migration issues. A detailed change log for the v8 series
      of compilers can be found at the end of the document.</para>
    </abstract>
  </info>

  <section>
    <title>Implementation Changes</title>

    <section>
      <title>Better Handling of <varname>SELF</varname></title>

      <para>Internally, the handling of <varname>SELF</varname> has been
      completely rewritten to reduce unnecessary cloning of values when using
      <varname>SELF</varname>. Moreover, specialized internal operands have
      been added to avoid unnecessary lookups in the variable symbol table
      when self is referenced. Overall, these changes should lead to faster
      execution and lower memory usage for statements involving
      <varname>SELF</varname>.</para>
    </section>

    <section>
      <title>Optimization</title>

      <para>This version of the compiler has begun to add some optimizations
      of statements and DML blocks. This first-level optimization involves the
      evaluation of compile-time constants to either remove branches in
      operator execution or to use specialized (and faster) versions of
      build-in functions. In many cases, this optimization allows stricter
      checking of syntax and validity checking of function arguments.
      Consequently, many errors that were caught only at run-time in previous
      compilers and now caught at compile-time.</para>
    </section>

    <section>
      <title>Read-Only Resources</title>

      <para>Internally, the resource objects (nlists and lists) have been
      extended to allow read-only versions of them. This will eventually allow
      resources to be cloned only when there is an attempt to modify them.
      Currently, global variables and values returned from the
      <function>value</function> function are cloned automatically. This is
      often unnecessary and leads to slower execution and greater memory
      usage. This is not yet used in the released version of the compiler, but
      will be phased in during minor releases of the panc v8 series.</para>
    </section>

    <section>
      <title>Remove Support for Binary Template Files</title>

      <para>The compiler no longer supports compilation of template files to
      an object file (as a java object serialization file). The overheads
      involved in the serialization process make recovering a template from
      the serialized file slower than recompiling the original template. Thus,
      this functionality provides no real benefit to the user. Removing this
      functionality also reduced the code base and simplified some
      methods.</para>
    </section>
  </section>

  <section>
    <title>Language Changes</title>

    <section>
      <title>Removed Keywords</title>

      <para>The keywords <literal>define</literal>, <literal>delete</literal>,
      <literal>description</literal>, and <literal>descro</literal> were
      deprecated in the panc v7 releases. Support for these deprecated
      keywords has been removed from the panc v8 releases. The
      <literal>define</literal> keyword can be simply removed from source
      templates. The <literal>description</literal> and
      <literal>descro</literal> clauses can be replaced with comments
      (starting with a pound sign and continuing until the end of the line).
      Statements using the <literal>delete</literal> keyword should be changed
      from:</para>

      <programlisting>delete '/my/path';</programlisting>

      <para>to an assignment to a <literal>null</literal> value:</para>

      <programlisting>'/my/path' = null;</programlisting>

      <para>This assignment has exactly the same effect as the
      <literal>delete</literal> statement. Note that the
      <function>delete</function> function is still permitted within a DML
      block.</para>
    </section>

    <section>
      <title>Removed Types</title>

      <para>The types <type>embed</type>, <type>stream</type>, and
      <type>fetch</type> are no longer supported in panc v8. There are
      currently no equivalents for these types in the panc language definition
      used in panc v8. If these types are being used, you must restructure
      your configuration to avoid them. Eventually, these types will be
      replaced with an XInclude type that will allow inclusion of external
      values in a more systematic and more standard way.</para>

      <para>The <type>link</type> type has also been removed as a separate
      type. The result is that the XML output will indicate that links have a
      <type>string</type> type and not a <type>link</type> type. This may have
      consequences for components that expressly use the NCM interface for
      links to retrieve values. However, as far as I can tell no component
      does so.</para>
    </section>

    <section>
      <title>Removed Functions</title>

      <para>The functions <function>hash</function> and
      <function>is_hash</function> have been removed. They were (unused)
      aliases for <function>nlist</function> and
      <function>is_nlist</function>, respectively.</para>
    </section>

    <section>
      <title>Deprecated Bareword Include</title>

      <para>An <literal>include</literal> statement may currently use a bare
      word to reference the template:</para>

      <programlisting>include my/template;</programlisting>

      <para>However, this complicates the pan parser because it must switch
      processing modes to allow this. Consequently, this form has been
      deprecated in the panc v8 series and will be removed in a future
      version. The preferred syntax is:</para>

      <programlisting>include { 'my/template' };</programlisting>

      <para>This is parsed more easily and when compiled is as efficient as
      the deprecated syntax. In the transition period, the braces are
      mandatory; once the support for the bareword include is removed, they
      will become optional. Support for the preferred syntax is already in the
      panc v7 series, so templates can already be changed to avoid the
      deprecated syntax.</para>
    </section>

    <section>
      <title>Using <literal>type</literal> Keyword for Binding
      Deprecated</title>

      <para>The ability to use the <literal>type</literal> keyword both for
      type definitions and for type binding creates an unnecessary branch
      point in the pan grammar. For efficiency and clarity, using the
      <literal>type</literal> keyword to bind a type to a path is deprecated
      in panc v8:</para>

      <programlisting>type 'my/path' = boolean;</programlisting>

      <para>For statements such as this, the <literal>type</literal> keyword
      should be replaced with <literal>bind</literal>:</para>

      <programlisting>bind 'my/path' = boolean;</programlisting>

      <para>When support for the deprecated grammar is removed, the processing
      within the pan parser can be simplified. The <literal>bind</literal>
      keyword is already supported in the panc v7 series, so these changes can
      already be made in existing templates.</para>
    </section>

    <section>
      <title>Lowercase Automatic Variables Deprecated</title>

      <para>Lowercase automatic variables have been deprecated in panc v8 and
      should be replaced by corresponding uppercase variable names. Removing
      support for lowercase variables brings usage of these variables in line
      with best practices regarding global variables. It also removes an
      ambiguity between the <literal>object</literal> keyword and the
      <varname>object</varname> variable name that will eventually simplify
      the pan grammar.</para>

      <para>The variables <varname>object</varname>, <varname>self</varname>,
      <varname>argc</varname>, <varname>argv</varname>, and
      <varname>loadpath</varname> should be replaced by
      <varname>OBJECT</varname>, <varname>SELF</varname>,
      <varname>ARGC</varname>, <varname>ARGV</varname>, and
      <varname>LOADPATH</varname>, respectively.</para>
    </section>

    <section>
      <title>External Path Syntax</title>

      <para>A new external path syntax can now be used; the new syntax allows
      object templates to be namespaced. The new syntax is:</para>

      <programlisting>my/object/tpl:/my/abs/path</programlisting>

      <para>showing a namespaced object template. The old external path syntax
      is still supported, but will be deprecated in a future release of the
      compiler. Please migrate to this new form.</para>
    </section>

    <section>
      <title>Namespaced Object Templates</title>

      <para>With the v8 versions of the compiler it is now possible to have
      namespaced object templates. This allows organization of the object
      templates in directory structures analogously to non-object templates.
      Values in namespaced object templates can only be referenced via the new
      external path syntax described in the previous section. The location of
      generated output files for namespaced object templates will be relative
      to the specified output directory with a path that mimics the given
      namespace. Be careful of using this feature as downstream components of
      the quattor toolkit (namely CCM) are not capable of locating namespaced
      object templates.</para>
    </section>

    <section>
      <title>Escaping Inside Literal Paths</title>

      <para>There are several situations in which a term in a path must be
      escaped; for example, when dealing with package names or with some
      device names that include slashes. Currently the only way to deal with
      such paths is to use the <function>escape</function> function, thus
      requiring use of a DML block. In many cases, this unnecessarily
      complicates a statement that could otherwise be written as a simple
      assignment statement, if the escaping were not necessary.</para>

      <para>The panc v8 series allows a literal path syntax, that
      automatically performs this escaping; simply surround the text to be
      escaped with braces. The statement:</para>

      <programlisting>'/my/complex/{a/b}/path' = 'OK';</programlisting>

      <para>will produce exactly the same result as:</para>

      <programlisting>'my/complex' = nlist(escape('a/b'), nlist('path', 'OK'));</programlisting>

      <para>except that in the first case only the <literal>a/b</literal>
      child is affected; the second case would remove all other children of
      <literal>/my/complex</literal>. Testing for and preserving the other
      children would further complicate the second statement.</para>

      <para>This syntax is a simple extension of the current syntax and has a
      couple of limitations: the escaped values may not be nested and braces
      themselves cannot be escaped.</para>
    </section>

    <section>
      <title>Restrictions on Structure Templates</title>

      <para>Currently the panc v7 series will allow structure templates to
      contain type declarations, function declarations, and variable
      assignments. All three of these change the global state when processing
      templates. As structure templates are always referenced from within a
      DML block, changing the global state should not be allowed, particularly
      being able to change global variables. Consequently, panc v8 forbids
      these statements from appearing in a structure template.</para>
    </section>

    <section>
      <title><varname>FUNCTION</varname> Automatic Variable Added</title>

      <para>The <varname>FUNCTION</varname> variable has been added. It is a
      global, final variable that contains the name of the function currently
      being executed. It doesn't exist if there is no function on the call
      stack. It is intended primarily for debugging and error messages.</para>
    </section>

    <section>
      <title><literal>for</literal> Loop Added</title>

      <para>A <literal>for</literal> loop has been added to the language. It
      has the syntax:</para>

      <programlisting>for (initialization-dml; condition-dml; increment-dml) body-dml</programlisting>

      <para>and behaves as it does in most programming languages. As for all
      statements in pan the <literal>for</literal> loop returns a value. The
      return value is value of the last statement executed in the
      <replaceable>body-dml</replaceable> or if the
      <replaceable>body-dml</replaceable> was never executed, then the value
      of the last statement in the
      <replaceable>initialization-dml</replaceable>.</para>
    </section>
  </section>

  <section>
    <title>Built-In Functions</title>

    <para>There are several new or changed built-in functions.</para>

    <itemizedlist>
      <listitem>
        <para><function>format</function>: Provides printf-like capabilities,
        allowing a string to be formatted according to a format string and
        list of values. The permitted formatting directives follow those
        available in Java.</para>
      </listitem>

      <listitem>
        <para><function>is_defined(a)</function>,
        <function>is_boolean(a)</function>, etc.: If these functions have a
        single variable reference as an argument, they will now return
        <literal>false</literal> if that variable does not exist. Currently,
        the processing will abort with an error. This essentially does an
        implicit <varname>if_exists</varname> call, allowing many conditional
        expressions to be simplified.</para>
      </listitem>

      <listitem>
        <para>String manipulation functions: There are now new string
        manipulation functions: <function>to_lowercase</function>,
        <function>to_uppercase</function>, <function>split</function>, and
        <function>replace</function>. These will allow less efficient and less
        general pan functions that perform similar functions to be
        replaced.</para>
      </listitem>

      <listitem>
        <para><function>to_string</function>: This function will now accept
        any element as an argument and produce a reasonable string
        representation of it. Previously, this function only accepted
        properties and complicated the use of debugging and error
        statements.</para>
      </listitem>

      <listitem>
        <para><function>path_exists</function>: This function will return true
        if the given absolute or external path exists. This function has been
        added to workaround an ambiguity in the <function>exists</function>
        function where the argument can be interpreted as a variable reference
        instead of using the value of the argument for a path.</para>
      </listitem>

      <listitem>
        <para><function>deprecated</function>: This function will print a
        deprecation warning to the console (stderr) if required by the
        deprecation level in effect for the compilation.</para>
      </listitem>
    </itemizedlist>

    <para>In general, these functions should be preferred to similar functions
    defined as pan functions; the built-in versions are more efficient.</para>
  </section>

  <section>
    <title>Client/Server Validation</title>

    <para>With this version of the pan compiler, it is now possible to have
    circular <emphasis>validation</emphasis> dependencies between machine
    profiles. This will allow better checking of the configuration for
    client/server situations. Note that circular <emphasis>build</emphasis>
    dependencies are still forbidden and will generate an error.</para>
  </section>

  <section>
    <title>Logging</title>

    <para>This release of the compiler includes the ability to log various
    activities of the pan compiler. The four types of logging are: "task",
    "call", "include", and "memory". The task logging can be used to extract
    information about how long the various processing phases last for a
    particular object template. The call logging allows the include graph to
    be reconstructed and to understand function calls; the "include" logging
    does not log function calls. The memory logging shows the memory usage
    during the template processing. The value "all" can be used to turn all
    logging on and "none", to turn all logging off. There are also a set of
    example perl scripts in the distribution that show how to analyze the
    logging information.</para>

    <para>Note that the stages of the build have changed slightly with the
    ability to treat circular validation dependencies. The stages one will see
    in the log files are: execute, defaults, valid1, valid2, xml, and dep.
    There is also a "build" stage that combines the execute and defaults
    stages.</para>
  </section>

  <section>
    <title>Miscellaneous Functionality</title>

    <para>A couple miscellaneous features have been added to the panc v8
    series:</para>

    <itemizedlist>
      <listitem>
        <para><varname>TEMPLATE</varname> automatic variable: This variable
        always includes the name of the template that invoked the running DML
        block. This will allow metadata embedded in the template name to be
        retrieved.</para>
      </listitem>

      <listitem>
        <para><varname>FUNCTION</varname> automatic variable: This variable is
        a global, final variable that contains the name of the function
        currently being executed. It doesn't exist if there is no function on
        the call stack. It is intended primarily for debugging and error
        messages.</para>
      </listitem>

      <listitem>
        <para>DOT output format: The configuration information can be written
        in the DOT output format. This format allows visualization of the
        configuration information as a graph. These files can be read by the
        Graphviz program.</para>
      </listitem>
    </itemizedlist>

    <para>In addition to these features, the release also includes a wider
    range of documentation, including a pan compiler manual, pan language
    manual, pan tutorial, and this README file. The documentation will be
    expanded and improved as the panc v8 series develops.</para>
  </section>

  <section>
    <title>Migration Issues</title>

    <section>
      <title>Global Variable Existence Tests</title>

      <para>Other that changes because of deprecated features, there is only
      one features of panc v8 that requires some changes to pan code. This
      involves how global variables are handled and respond to the
      <function>exists</function> function. In panc v8, as soon as a variable
      statement starts execution it sets the value of the variable to
      <literal>undef</literal>. Previously, the value was left undefined. This
      causes a change in behavior when the <function>exists</function>
      function is applied to the same variable that is being set. That is the
      following statement with leave the variable <varname>X</varname> always
      <literal>true</literal> in panc v8:</para>

      <programlisting>variable X = exists(X);</programlisting>

      <para>Previously, the value could be either <literal>true</literal> or
      <literal>false</literal> depending on whether <varname>X</varname>
      existed before the statement executed.</para>

      <para>Problems arise when tri-state variables (using
      <literal>true</literal>, <literal>false</literal>, and
      <literal>undef</literal> as the three states) are used. Code
      like:</para>

      <programlisting>variable X ?=
  if (!exists(X)) {
    undef;
  } else {
    false;
  };</programlisting>

      <para>must be replaced with code like:</para>

      <programlisting>variable EXISTS = exists(X);
variable X ?=
  if (!EXISTS) {
    undef;
  } else {
    false;
  };</programlisting>

      <para>The second block of code will produce exactly the same results in
      both the v7 and v8 series of the compiler. Better still is to use
      tri-state variables that use <literal>null</literal>,
      <literal>true</literal>, and <literal>false</literal> as the three
      states. In this case, the <function>is_null</function> function can be
      used instead and the different behavior between versions can be avoided
      entirely.</para>
    </section>

    <section>
      <title><varname>SELF</varname> Usage</title>

      <para>The processing of SELF has been optimized in the latest version of
      the pan compiler. This unfortunately does have some user-visible
      consequences. Most notably setting a local variable to SELF
      <emphasis>will now create a copy</emphasis> of the value of SELF. In
      particular if SELF was a resource, then the local variable and SELF will
      contain two distinct copies and further modifications of the local
      variable will not affect SELF.</para>

      <programlisting># The path /result will be undef and NOT contain a child named 'orphan'!
'/result' = {
  x = SELF;
  x['orphan'] = 'alice';
  SELF;
};</programlisting>

      <para>Code that manipulates SELF, especially code that modifies SELF,
      should always reference SELF directly. This allows the compiler to avoid
      unnecessary copies and to optimize the code.</para>

      <programlisting># Code that has the expected behavior.  The path '/result' WILL have
# a child 'orphan' named 'alice'.
'/result' = {
  SELF['orphan'] = 'alice';
  SELF;
};</programlisting>

      <warning>
        <para>There is a case of this usage in the
        <function>filesystem_mod</function> function defined in the
        <literal>quattor/functions/filesystem template</literal>. Please be
        sure to use the latest version of this function in the quattor
        repository.</para>
      </warning>
    </section>

    <section>
      <title>Object Template Visible from Include Directories</title>

      <para>In a change from previous versions of the compiler, the compiled
      object templates <emphasis>must</emphasis> be visible from the specified
      include directories. In the past, it was possible to specify object
      templates that were not visible from the include directories on the
      command line. Doing this will generate an error with this version of the
      compiler. The more rigorous checking ensures that there are no
      ambiguities about what file is used for a given object.</para>
    </section>
  </section>

  <section>
    <title>Change Log</title>

    <section>
      <title>Version 8.2.5</title>

      <itemizedlist>
        <listitem>
          <para>(SF BUG #2371882) Catch a StackOverflowError that results from
          the creation of a circular data structure. This now causes an
          EvaluationException with approximate location information and a hint
          that it is probably caused by a circular data structure.</para>
        </listitem>

        <listitem>
          <para>(SF BUG #2213918) Update the pan language manual to indicate
          that object templates can now be namespaced.</para>
        </listitem>

        <listitem>
          <para>(SF RFE #2381822) Add documentation of ant task attributes and
          nested elements to pan compiler manual.</para>
        </listitem>

        <listitem>
          <para>(SF RFE #2371275) Remove deprecated ant task attributes. The
          attributes <literal>objWriteEnabled</literal>,
          <literal>objLoadEnabled</literal>, and
          <literal>debugEnabled</literal> have been removed from the panc ant
          task. Build files should remove references to those
          attributes.</para>
        </listitem>

        <listitem>
          <para>(SF RFE #2351170) Add full path names for include logging. The
          full path names of included templates now appear in the generated
          log. This is useful in situations where the dependency file is not
          generated (e.g. when the profile does not compile).</para>
        </listitem>
      </itemizedlist>
    </section>

    <section>
      <title>Version 8.2.4</title>

      <itemizedlist>
        <listitem>
          <para>(SF RFE #2213785) Added support for annotations. The compiler
          will accept the annotation syntax, but currently does not provide a
          programmatic mechanism for extracting or processing the information
          within the annotation. A compiler option has been added
          (<option>--dump-annotations</option>) to allow processed annotations
          to be dumped to the standard output; by default, the information is
          not printed. The corresponding option for the panc ant task is
          <option>dumpAnnotations</option>.</para>
        </listitem>

        <listitem>
          <para>(SF RFE #2213794) The <function>debug</function> and
          <function>traceback</function> functions can now be selectively
          enabled/disabled. A set of include and exclude regular expressions
          can be specified via the command line or via parameters of the ant
          task. Those functions will be activated within any template whose
          name matches at least one include regular expression but matches
          none of the exclude regular expressions. The command line options
          are <option>--debug-include</option>,
          <option>--debug-exclude</option>, and the older
          <option>--debug</option>. For the panc ant task, the include/exclude
          regular expressions can be specified with embedded debug elements.
          You can have multiple debug elements. The debug element takes an
          <option>include</option> and/or an <option>exclude</option>
          option.</para>
        </listitem>
      </itemizedlist>
    </section>

    <section>
      <title>Version 8.2.3</title>

      <itemizedlist>
        <listitem>
          <para>(Trac bug #193) Fixed incorrect lookup of templates when
          handling <filename>*.del</filename> files.</para>
        </listitem>

        <listitem>
          <para>(Trac bug #194) Fixed a problem with the documentation where
          the final versions contained unprocessed xinclude directives.</para>
        </listitem>

        <listitem>
          <para>The <command>panc</command> man page has been added back to
          the release. This was inadvertently dropped in the v8.2.2
          release.</para>
        </listitem>

        <listitem>
          <para>Grammar now includes support for a prototype annotation
          syntax. The changes also make the annotation and comment information
          available to the parser. In this version, no additional processing
          of these is done.</para>
        </listitem>

        <listitem>
          <para>This release should be compatible with the latest version of
          CDB.</para>
        </listitem>

        <listitem>
          <para>The compiler now uses junit 4.5 and JavaCC 4.1
          internally.</para>
        </listitem>
      </itemizedlist>
    </section>

    <section>
      <title>Version 8.2.2</title>

      <itemizedlist>
        <listitem>
          <para>(Trac bug #192) The functions <function>exist</function> and
          <function>path_exists</function> should return
          <literal>false</literal> and not an error when a resources along the
          path cannot be dereferenced.</para>
        </listitem>
      </itemizedlist>
    </section>

    <section>
      <title>Version 8.2.1</title>

      <itemizedlist>
        <listitem>
          <para>(Trac bug #189) Output file names contain URL escapes when the
          parent path contains spaces (or other special characters).</para>
        </listitem>
      </itemizedlist>
    </section>
  </section>
</article>
